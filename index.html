<!DOCTYPE html>
<html>
  <head>
    <title>Existência Híbrida - RA (Versão Final)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="./libs/aframe.min.js"></script>
    <script src="./libs/mindar-image-aframe.prod.js"></script>

    <style>
      #start-button-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
      }
      #start-button {
        padding: 15px 30px;
        font-size: 20px;
        border: 2px solid white;
        background-color: transparent;
        color: white;
        cursor: pointer;
        border-radius: 10px;
        font-family: sans-serif;
      }
    </style>
  </head>
<body>

  <div id="start-button-container">
    <button id="start-button">Iniciar Experiência</button>
  </div>

  <a-scene 
    mindar-image="imageTargetSrc: ./targets.mind; autoStart: false; maxTrack: 3;"
    color-space="sRGB" 
    renderer="colorManagement: true, physicallyCorrectLights" 
    vr-mode-ui="enabled: false" 
    device-orientation-permission-ui="enabled: false">
    
    <a-assets>
      <video id="vid1" src="./AI_Colonia.webm" loop="true" muted playsinline webkit-playsinline></video>
      <video id="vid2" src="./AI_Coxa.webm" loop="true" muted playsinline webkit-playsinline></video>
      <video id="vid3" src="./AI_Folha.webm" loop="true" muted playsinline webkit-playsinline></video>
      <!--
      <video id="vid4" src="./caminho/para/seu/video4.webm" loop="true" muted playsinline webkit-playsinline></video>
      -->
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0" video-handler>
      <a-plane 
        material="src: #vid1; transparent: true; shader: flat; alphaTest: 0.5"
        position="0 0 0" 
        height="1.26" 
        width="1" 
        rotation="0 0 0">
      </a-plane>
    </a-entity>
    
    <a-entity mindar-image-target="targetIndex: 1" video-handler>
      <a-plane 
        material="shader: chromakey; src: #vid2; color: #000000; transparent: true"
        position="0 0 0" 
        height="1.26" 
        width="1" 
        rotation="0 0 0">
      </a-plane>
    </a-entity>

    <a-entity mindar-image-target="targetIndex: 2" video-handler>
      <a-plane 
        material="src: #vid3; transparent: true; shader: flat; alphaTest: 0.5"
        position="0 0 0" 
        height="2.52" 
        width="2" 
        rotation="0 0 0">
      </a-plane>
    </a-entity>
    <!--
    <a-entity mindar-image-target="targetIndex: 3" video-handler>
      <a-plane 
        material="src: #vid4; transparent: true; shader: flat; alphaTest: 0.5"
        position="0 0 0" 
        height="1.26" 
        width="1" 
        rotation="0 0 0">
      </a-plane>
    </a-entity>
    -->
    
  </a-scene>


<script>
  // NOVO COMPONENTE: Mais genérico e reutilizável
  AFRAME.registerComponent('video-handler', {
    init: function() {
      // Pega o elemento de vídeo que está DENTRO desta entidade
      this.video = this.el.querySelector('a-plane').getObject3D('mesh').material.map.image;
      this.marker = this.el; // A entidade <a-entity> é o próprio marcador

      this.marker.addEventListener("targetFound", () => {
        console.log("Marcador encontrado, tocando vídeo:", this.video.id);
        this.video.play();
      });

      this.marker.addEventListener("targetLost", () => {
        console.log("Marcador perdido, pausando vídeo:", this.video.id);
        this.video.pause();
        this.video.currentTime = 0; // Opcional: reseta o vídeo para o início
      });
    }
  });

  // Lógica para o botão de iniciar (ajustada para os 4 vídeos)
  document.addEventListener('DOMContentLoaded', () => {
    const sceneEl = document.querySelector("a-scene");
    
    sceneEl.addEventListener('loaded', () => {
      const startButtonContainer = document.querySelector("#start-button-container");
      const startButton = document.querySelector("#start-button");
      const mindarSystem = sceneEl.systems['mindar-image-system'];
      const videos = document.querySelectorAll("video");

      startButton.addEventListener('click', () => {
        // Truque para permitir o autoplay em navegadores mobile
        videos.forEach((video) => {
          video.play();
          video.pause();
          video.playbackRate = 0.5; // Mantém sua configuração de velocidade
        });
        
        startButtonContainer.style.display = 'none';
        mindarSystem.start();
      });
    });
  });
</script>
  </body>
</html>
